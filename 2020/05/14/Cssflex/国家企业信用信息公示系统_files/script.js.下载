var isPhoneVerifyCode=false;
$(function(){
var handleralert = function (captchaObj) {
    captchaObj.onReady(function () {
        $("#wait").hide();
    }).onSuccess(function () {
        var result = captchaObj.getValidate();
        if (!result) {
            return alert('请完成验证');
        }else{
        	$("#geetest_challenge").val(result.geetest_challenge);
        	$("#geetest_validate").val(result.geetest_validate);
        	$("#geetest_seccode").val(result.geetest_seccode);
        	if(isPhoneVerifyCode){
        		loginCtr.alertSendCodeLogin();
        	}else{
        		loginCtr.alert_Login();
        	}
        }
    });
    $("#alert_login_btn").on("click", function(){
    	isPhoneVerifyCode= false;
		var phoneinfo = document.getElementById("id_account_l").value;
		var gsxtpinfo = document.getElementById("id_gsxtp_l").value;
		if(phoneinfo ==''){
			$("#msg").text("请输入手机号");
			return false;
		}else if(phoneinfo != ''){
			if(!(/^1[345678]\d{9}$/.test(phoneinfo))){
		        $("#msg").text("手机号码有误，请重填");
		        return false;
		    }
			if(!(gsxtpinfo)){
				$("#msg").text("请输入密码");
    			return false;
			}
			else{
				captchaObj.verify();
			}
		}
    });
	$("#getfastcode").on("click", function(){
		var phoneinfo = document.getElementById("id_phone2").value;
		if(phoneinfo ==''){
			$("#msg").text("请输入手机号");
			return false;
		}else if(phoneinfo != ''){
			if(!(/^1[345678]\d{9}$/.test(phoneinfo))){
		        $("#msg").text("手机号码有误，请重填");
		        return false;
		    }else{
		    	$.ajax({
		            url: "/use-phone-check.html",
		            type: 'POST',
		            data:{'phone':phoneinfo},
		            success: function (resp) {
		            	if(resp.message != ''){
		            		$("#msg").text(resp.message);
		                  	$(".baseBtn").css("pointer-events","none");
		                  	$("#id_code").prop('disabled', true);
		                 }
		            	else{
		            		$(".baseBtn").css("pointer-events","auto");
		                    $('#id_code').prop('disabled', false);
		                    isPhoneVerifyCode = true;
		                    captchaObj.verify();
		                }
		            }
		        });
		    }
		}
    });
    // 更多前端接口说明请参见：http://docs.geetest.com/install/client/web-front/
};
$.ajax({
    url: "/SearchItemCaptcha?t=" + (new Date()).getTime(), // 加随机数防止缓存
    type: "get",
    dataType: "json",
    success: function (data) {

        // 调用 initGeetest 进行初始化
        // 参数1：配置参数
        // 参数2：回调，回调的第一个参数验证码对象，之后可以使用它调用相应的接口
        initGeetest({
            // 以下 4 个配置参数为必须，不能缺少
            gt: data.gt,
            challenge: data.challenge,
            offline: !data.success, // 表示用户后台检测极验服务器是否宕机
            new_captcha: data.new_captcha, // 用于宕机时表示是新验证码的宕机
//            timeout: '5000',
            product: "bind", // 产品形式，包括：float，popup
            width: "300px"
            // 更多前端配置参数说明请参见：http://docs.geetest.com/install/client/web-front/
        }, handleralert);
    }
});
});
$(function () {
	$(".login-input").on("keypress", function(event){
        if (event.keyCode === 13) {
        	$(".login-input").blur();
        	$("#alert_login_btn").trigger("click");
        }
    });
	$(".phone-input").on("keypress", function(event){
        if (event.keyCode === 13) {
        	$(".phone-input").blur();
        	loginCtr.phonelogin();
        }
    });
	
});
function inputChange(){
	$("#msg").text("");
	$(".baseBtn").css("pointer-events","auto");
}
$(document).ready(function () {	
	$("#phonemima").on("click",function(){
		$('.phone').css('display','block');
		$('.common').css('display','none');
		$(this).addClass('cur');
		$('#commonmima').removeClass('cur');
		$("#msg").text("");
	});
	$("#commonmima").on("click",function(){
		$('.phone').css('display','none');
		$('.common').css('display','block');
		$(this).addClass('cur');
		$('#phonemima').removeClass('cur');
		$("#msg").text("");
	})
});
$(function () {
    avalon.scan();

});
var loginCtr = avalon.define({
    $id: 'AlertLoginController',
    rowb: {
        phone : '',
        verifyCode: ''
    },
    row: {
        phone: '',
        gsxtp: '',
    },
    getMixRow: function () {
        return avalon.mix(true, {}, loginCtr.row.$model);
    },
    getMaxRow: function () {
        return avalon.mix(true, {}, loginCtr.rowb.$model);
    },
    alert_Login: function () {
        var row = loginCtr.getMixRow();
        var result = loginCtr.validate(row);
        if (!result.valid) {
            $("#msg").text(result.msg);
            return false;
        }
        $.ajax({
            url: "/socialuser-use-login-request.html",
            type: "POST",
            async: false,
            data:{'phone': row.phone,
            	'gp': $.md5(row.gsxtp),
            	'geetest_challenge':$("#geetest_challenge").val(),
            	'geetest_validate':$("#geetest_validate").val(),
            	'geetest_seccode':$("#geetest_seccode").val()
            	},
            success: function (resp) {
                if (resp.success) {
                	 window.location.reload();
                }
                else if (resp.success==false){
                    $("#msg").text(resp.message);
                }
            }
        })
    },
 // 获取验证码
    alertSendCodeLogin: function (event) {
        var row = loginCtr.getMaxRow();
        if (!row.phone) {
            $("#msg").text('请先输入手机号');
            return false;
        }
        if(!(/^1[345678]\d{9}$/.test(row.phone))){
            $("#msg").text('手机号码有误，请重填');
            return false;
        }
        $.ajax({
            url: "/use-login-sendVerifyCode.html",
            type: "GET",
            data:{
            	'geetest_challenge':$("#geetest_challenge").val(),
            	'geetest_validate':$("#geetest_validate").val(),
            	'geetest_seccode':$("#geetest_seccode").val()
            	},
            success: function (data) {
            	if (!data.success) {
          		    $("#msg").text(data.message);
                }else if(data.success){
                	var time = 59;
                    $("#getfastcode").text("重新发送(" + time + ")");
                    var timer = setInterval(function () {
                        time--;
                        if (time <= 0) {
                            $("#getfastcode").text("获取验证码");
                            clearInterval(timer);
                            time = 59;
                            return false;
                        }
                        $("#getfastcode").text("重新发送(" + time + ")");
                    }, 1000);
                }
            }
        });
    },
    phonelogin: function () {
        var row = loginCtr.getMaxRow();
        var result = loginCtr.validatea(row);
        if (!result.valid) {
        	$("#msg").text(result.msg);
            return false;
        }
        $.ajax({
            contentType: "application/json",
            url: "/use-login-phone.html",
            type: "POST",
            async: false,
            data: $.toJSON(row),
            success: function (resp) {
                if (resp.success) {
                	 window.location.reload();
                }
                else if(!resp.success){
                    $("#msg").text(resp.message);
                }
            }
        })
    },
    validate: function (row) {
        var valid = true,
            msg = '';
        if (!row.phone) {
            valid = false;
//            msg = '请输入用户名或手机号';
            msg = '请输入手机号';
        }
        else if (!(row.gsxtp)) {
            valid = false;
            msg = '请输入密码';
        }
        
        return {
            valid: valid,
            msg: msg
        }
    },
    validatea: function (row) {
        var valid = true,
            msg = '';
        if (!row.phone) {
            valid = false;
//            msg = '请输入用户名或手机号';
            msg = '请输入手机号';
        }
        else if (!row.verifyCode) {
            valid = false;
            msg = '请输入验证码';
        }
        
        return {
            valid: valid,
            msg: msg
        }
    }
});

function showLogin() {
	$('.login-bgPop,.login-pop').show();
}

$(document).ready(function () {
    $('.login-pop-close').click(function () {
        $('.login-bgPop,.login-pop').hide();
    });    
});
